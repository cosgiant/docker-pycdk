name: "🐳🔐📦 Docker Login and Pull Image"

on:
  workflow_call:
    inputs:
      image_registry:
        description: "ghcr.io or other package registry"
        required: true
        type: string
      image_name:
        description: "🖼️ The name of the Docker image to pull"
        required: true
        type: string
      image_tags:
        description: "🏷️ Comma-separated list of tags for the Docker image"
        required: true
        type: string
    secrets:
      GHCR_TOKEN:
        required: true

# Set Global permissions
permissions:
  packages: read
  contents: read

jobs:
  login_and_pull:
    runs-on: ubuntu-latest
    steps:
      - name: "🔐🐳 Log in to the Container registry"
        id: docker_login_action
        uses: docker/login-action@v3.3.0
        with:
          registry: ${{ inputs.image_registry }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Extract metadata (tags, labels) for Docker"
        id: meta
        uses: docker/metadata-action@v5.5.1
        with:
          images: ${{ inputs.image_registry }}/${{ inputs.image_name }}
          tags: |
            type=raw,value=${{inputs.image_tags}}
            type=raw,value=v${{inputs.image_tags}}
            type=raw,value=latest

  #type=raw,value=${{inputs.package_registry}}/${{inputs.image_name}}:${{env.PYCDK_VER}}
  # - ghcr.io/cosgiant/pycdk:2.155.0
  # - ghcr.io/cosgiant/pycdk:v2.155.0
  # - ghcr.io/cosgiant/pycdk:latest

  # - name: Build and push Docker image
  #   uses: docker/build-push-action@v6.7.0
  #   with:
  #     context: .
  #     push: true
  #     tags: ${{ steps.meta.outputs.tags }}
  #     labels: ${{ steps.meta.outputs.labels }}
  #     build-args: CDK_VERSION=${{ steps.get-ver.outputs.cdkver }}
  #   - name: "🔐🐳 Docker login to ghcr registry"
  #     run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin      
      - name: "🔐🐳 Docker sign in to registry: ${{ inputs.image_registry }}/${{ inputs.image_name }}:${{ inputs.image_tags }}"
        id: docker_login_cli
        env:
          PYCDK_REPO: ${{ inputs.image_registry }}/${{ inputs.image_name }} #${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} #${{ vars.PYCDK_REPO }}
          PYCDK_VER: ${{ inputs.image_tags }}
        run: |
          echo "🐳 Docker Login to ${{ inputs.image_registry }} Container Registry"
          echo "Calling Repository: ${{ github.repository }}"
          # echo "${{ secrets.AHSENB_PAT_GH_PACKAGES_PYCDK_READONLY }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin        
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          echo "🐳📦 Docker Pull from GitHub Container Registry"
          echo "===> Pulling $PYCDK_REPO:$PYCDK_VER"
          docker pull $PYCDK_REPO:$PYCDK_VER
          echo "🐳📦 Docker Images"
          docker images $PYCDK_REPO:$PYCDK_VER

      - name: "📦🐳 Docker Pull from Container Registry"
        id: docker_pull
        
        run: |
          IFS=',' read -r -a tags <<< "${{ inputs.image_tags }}"
          for tag in "${tags[@]}"; do
            echo "===> Pulling ${{ inputs.image_name }}:$tag"
            docker pull ${{ inputs.image_name }}:$tag
          done

      - name: "🖼️🐳 Docker Images"
        run: |
          echo "Docker images: ${{ inputs.image_name }}"
          docker images ${{ inputs.image_name }}
